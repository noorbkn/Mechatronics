<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air Quality History</title>

<style>
:root { color-scheme: dark; }
body {
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  margin:0; padding:1.25rem;
  background:#0b1220; color:#e5e7eb;
}
h1 { margin:0 0 .25rem; font-size:1.35rem; }
.sub { color:#94a3b8; font-size:.9rem; margin-bottom:1rem; }

.row { display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; }
.card {
  background:#0f172a; border:1px solid rgba(255,255,255,.06);
  border-radius:14px; padding:1rem;
  min-width:160px; flex:1;
  transition: border 0.3s ease;
}
.label { color:#94a3b8; font-size:.75rem; letter-spacing:.08em; text-transform:uppercase; }
.value { font-size:1.6rem; margin-top:.35rem; }

/* In/Out of Range Indication Colors */
.warn { color: #fbbf24 !important; border-color: rgba(251, 191, 36, 0.4); } 
.crit { color: #f87171 !important; border-color: rgba(248, 113, 113, 0.5); font-weight: bold; }
tr.crit-row { background: rgba(248, 113, 113, 0.1); }

.panel {
  margin-top:1rem;
  background:#0f172a; border:1px solid rgba(255,255,255,.06);
  border-radius:14px; padding:1rem;
  position: relative;
}

canvas {
  width:100%; height:260px;
  background:#0b1220; border-radius:12px;
  border:1px solid rgba(255,255,255,.06);
  cursor: crosshair;
}

.tooltip {
  position: absolute;
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 8px; border-radius: 6px;
  pointer-events: none; font-size: 0.8rem;
  display: none; z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

table { width:100%; border-collapse:collapse; margin-top:.75rem; }
th, td { border-bottom:1px solid rgba(255,255,255,.07); padding:.55rem .6rem; font-size:.9rem; }
th { color:#94a3b8; text-transform:uppercase; font-size:.7rem; text-align: left; }

.grid2 { display:grid; grid-template-columns:1fr; gap:1rem; }
@media (min-width:900px){ .grid2{ grid-template-columns:1fr 1fr; } }
</style>
</head>

<body>
<h1>Air Quality History</h1>
<div class="sub">Latest Status & Historical Trends</div>

<div class="panel">
  <input id="file" type="file" accept=".csv">
  <span id="status" style="margin-left:1rem;color:#94a3b8">Waiting for CSV...</span>
</div>

<div class="row" style="margin-top:1rem">
  <div class="card" id="cardTemp"><div class="label">Temp</div><div class="value"><span id="kTemp">—</span> °C</div></div>
  <div class="card" id="cardHum"><div class="label">Humidity</div><div class="value"><span id="kHum">—</span> %</div></div>
  <div class="card" id="cardCO2"><div class="label">CO₂</div><div class="value"><span id="kCO2">—</span> ppm</div></div>
  <div class="card" id="cardAQI"><div class="label">AQI</div><div class="value"><span id="kAQI">—</span></div></div>
  <div class="card" id="cardTVOC"><div class="label">TVOC</div><div class="value"><span id="kTVOC">—</span></div></div>
  <div class="card"><div class="label">Fan</div><div class="value"><span id="kFan">—</span></div></div>
</div>

<div id="tooltip" class="tooltip"></div>

<div class="grid2">
  <div class="panel"><div class="label" style="color:#ff4444">Temperature (°C)</div><canvas id="cTemp"></canvas></div>
  <div class="panel"><div class="label" style="color:#44ff44">CO₂ (ppm)</div><canvas id="cCO2"></canvas></div>
</div>

<div class="grid2">
  <div class="panel"><div class="label" style="color:#4444ff">Humidity (%)</div><canvas id="cHum"></canvas></div>
  <div class="panel"><div class="label" style="color:#ffff44">TVOC</div><canvas id="cTVOC"></canvas></div>
</div>

<div class="panel">
  <div class="label" style="color:#ff44ff">Air Quality Index</div>
  <canvas id="cAQI"></canvas>
</div>

<div class="panel">
  <div class="label">Logged Data Entries</div>
  <table id="table">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const $ = id => document.getElementById(id);
let rows = [];
const activeCharts = [];

// Range logic for highlights
const Limits = {
  co2:  { warn: 800,  crit: 1100 },
  aqi:  { warn: 2,    crit: 4    },
  tvoc: { warn: 100,  crit: 300  }
};

function getRangeClass(key, val) {
  if (!Limits[key]) return "";
  if (val >= Limits[key].crit) return "crit";
  if (val >= Limits[key].warn) return "warn";
  return "";
}

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/).filter(l => l.includes(','));
  // slice(2) to skip title and headers
  return lines.slice(2).map((l, i) => {
    const c = l.split(',');
    return {
      ts: c[0] || i,           
      x: i,
      temp: parseFloat(c[1]),  
      hum: parseFloat(c[2]),   
      co2: parseFloat(c[3]),
      aqi: parseFloat(c[4]),
      tvoc: parseFloat(c[5]),
      fan: c[6] ? c[6].trim() : "OFF"
    };
  });
}

function drawChart(id, key, color) {
  const c = $(id);
  const ctx = c.getContext("2d");
  c.width = c.clientWidth;
  c.height = c.clientHeight;

  const pad = 40;
  const xs = rows.map(r => r.x);
  const ys = rows.map(r => r[key]);

  const xmin = Math.min(...xs), xmax = Math.max(...xs);
  let ymin = Math.min(...ys), ymax = Math.max(...ys);
  if (ymin === ymax) { ymin -= 1; ymax += 1; }

  const xMap = x => pad + (x - xmin) / (xmax - xmin) * (c.width - 2 * pad);
  const yMap = y => c.height - pad - (y - ymin) / (ymax - ymin) * (c.height - 2 * pad);

  activeCharts.push({ id, key, xMap, yMap, color });

  ctx.clearRect(0, 0, c.width, c.height);
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  rows.forEach((r, i) => {
    const x = xMap(r.x);
    const y = yMap(r[key]);
    i ? ctx.lineTo(x, y) : ctx.moveTo(x, y);
  });
  ctx.stroke();

  // Draw X Labels
  ctx.fillStyle = "#94a3b8";
  ctx.font = "10px sans-serif";
  const labelFreq = Math.max(1, Math.floor(rows.length / 5));
  rows.forEach((r, i) => {
    if (i % labelFreq === 0) ctx.fillText(r.ts, xMap(r.x) - 10, c.height - 10);
  });
}

function handleMouseMove(e) {
  const chart = activeCharts.find(ch => ch.id === e.target.id);
  if (!chart || !rows.length) return;

  const rect = e.target.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  
  let closest = rows[0];
  let minDist = Math.abs(mouseX - chart.xMap(rows[0].x));
  rows.forEach(r => {
    const d = Math.abs(mouseX - chart.xMap(r.x));
    if (d < minDist) { minDist = d; closest = r; }
  });

  const tip = $("tooltip");
  tip.style.display = "block";
  tip.style.left = `${e.pageX + 15}px`;
  tip.style.top = `${e.pageY - 15}px`;
  tip.className = "tooltip " + getRangeClass(chart.key, closest[chart.key]);
  tip.innerHTML = `<strong>${closest.ts}</strong><br/>${chart.key.toUpperCase()}: ${closest[chart.key]}`;
}

function render() {
  activeCharts.length = 0;
  if (!rows.length) return;

  const last = rows[rows.length - 1];
  
  // Set KPI Card Values
  $("kTemp").textContent = last.temp.toFixed(1);
  $("kHum").textContent = last.hum.toFixed(1);
  $("kCO2").textContent = last.co2;
  $("kAQI").textContent = last.aqi;
  $("kTVOC").textContent = last.tvoc;
  $("kFan").textContent = last.fan;

  // Set KPI Card colors based on Range
  ["temp", "hum", "co2", "aqi", "tvoc"].forEach(k => {
    const card = $("card" + k.charAt(0).toUpperCase() + k.slice(1));
    if (card) card.className = "card " + getRangeClass(k, last[k]);
  });

  const conf = [
    ["cTemp", "temp", "#ff4444"], ["cCO2", "co2", "#44ff44"],
    ["cHum", "hum", "#4444ff"], ["cTVOC", "tvoc", "#ffff44"],
    ["cAQI", "aqi", "#ff44ff"]
  ];

  conf.forEach(c => {
    drawChart(...c);
    $(c[0]).onmousemove = handleMouseMove;
    $(c[0]).onmouseout = () => $("tooltip").style.display = "none";
  });

  $("table").querySelector("thead").innerHTML = "<tr><th>Time</th><th>Temp</th><th>Hum</th><th>CO₂</th><th>AQI</th><th>TVOC</th><th>Fan</th></tr>";
  $("table").querySelector("tbody").innerHTML = rows.map(r => `
    <tr class="${getRangeClass('co2', r.co2) === 'crit' ? 'crit-row' : ''}">
      <td>${r.ts}</td><td>${r.temp}</td><td>${r.hum}</td>
      <td class="${getRangeClass('co2', r.co2)}">${r.co2}</td>
      <td class="${getRangeClass('aqi', r.aqi)}">${r.aqi}</td>
      <td class="${getRangeClass('tvoc', r.tvoc)}">${r.tvoc}</td>
      <td>${r.fan}</td>
    </tr>`).join('');
}

$("file").addEventListener("change", async e => {
  const text = await e.target.files[0].text();
  rows = parseCSV(text);
  render();
  $("status").textContent = `Loaded ${rows.length} rows`;
});
</script>
</body>
</html>
